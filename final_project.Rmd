---
title: "Advanced Data Analysis in R : Final Project"
output: html_document
date: '2022-06-13'
author: 'Lucila Silbermann & Shani Landsberger'
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(broom)
library(htmltools)
library(expss)
library(dplyr)
library(haven)
library(ggplot2)
```

```{r knitr, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load, message = FALSE}
setwd("~/Desktop/BGU/תכנות מתקדם/proj")
X3rd_assessment <- read_sav("data/3rd assessment.sav")
child_risk_t12 <- read_sav("data/child_risk_t12.sav")
```

## Load Data and perform preprocessing
```{r preprocess, message = FALSE}
# Filter data sets to only include the relevant features
set12 <- child_risk_t12[,c(1,8,9,17,18,19,20,24,25,145,146,147,148,190,150,152,158,180,218,230,231,233,234)]
set3 <- X3rd_assessment[,c(13,21,29,32,33,41,42,48,190,203,204)]
# Handle duplicates in Set3
## find duplicated ids
n_occur <- data.frame(table(set3$T3interviewee_number)) # count occurences of each id
duplicates <- set3[set3$T3interviewee_number %in% n_occur$Var1[n_occur$Freq > 1],]
duplicates <- distinct(duplicates[1]) 
duplicatesids <- duplicates %>% pull(T3interviewee_number)
## generate set3 without duplicates
dedupset3 <- set3[!duplicated(set3$T3interviewee_number),]
for (duplicate in duplicatesids){
  # loop through duplicates
    same <- set3[set3$T3interviewee_number == duplicate, ]
    #if (length(same) == 2){
  for (i in colnames(set3)){ # loop through columns
 # get all rows with id=duplicate
    if ((is_empty(same[1,i])||is.na(same[1,i])) & (is_empty(same[2,i])||is.na(same[2,i]))){ # both rows have na in current column
      
      max_frequent <- c(dedupset3[,i])
      freq = sort(table(max_frequent), decreasing = TRUE)[1]
      new = names(freq)[which.max(freq)]
      same[1,i] = as.numeric(new)
    }
    else if ((is.na(same[1,i])) & (length(same[2,i])>0)){ # first duplicate is NA or empty while second duplicate has a value
      same[1,i] = same[2,i] # keep value from second duplicate
    }
  }
  # all other cases (first duplicate is populated)
  set3 <- set3[set3$T3interviewee_number != duplicate, ]
 # removed duplicates
  set3 <- rbind(set3,same[1,]) # keep first duplicate with populated columns
} 
# find most frequent value in vector or column
most_freq <- function(x){
    max_frequent <- c(x)
    freq = sort(table(max_frequent), decreasing = TRUE)[1]
    names(freq)[which.max(freq)]
}
#remove NA from dataset3
for (col in names(set3)){ 
  value <- as.numeric(most_freq(set3[[col]]))
  vec <- set3[[col]]
  vec[is.na(vec)] <- value
  set3[[col]] <- vec
}
#remove NA from dataset 12
for (col in names(set12)){
  value <- as.numeric(most_freq(set12[[col]]))
  vec <- set12[[col]]
  vec[is.na(vec)] <- value
  set12[[col]] <- vec
}
set3 <- transform(set3, T3interviewee_number = as.numeric(T3interviewee_number))
# join preprocessed data set to a complete df
full_dataset <- inner_join(set12,set3,by=c("serial_number"="T3interviewee_number"))
```


## Run Kmeans Algorithm on Full Dataset
```{r init_ kmeans, message = FALSE}
set.seed(5)
km <- kmeans(full_dataset, 3, 20)
kmeansRes<-factor(km$cluster)
full_dataset$clusternum <- kmeansRes
metrics <- full_dataset %>% count(clusternum)
metrics
```

```{r remove_outlier_kmeans,message = FALSE}
full_dataset %>% filter(full_dataset$clusternum == 1)
anomaly <- full_dataset %>% filter(full_dataset$clusternum == 1)
full_dataset <- full_dataset %>% subset(full_dataset$clusternum != 1)

metrics <- full_dataset %>% count(clusternum)
metrics
```

```{r kmeans,message = FALSE}
# run algorithm with k=4 without the outlier
km <- kmeans(full_dataset, 4, 20)
kmeansRes<-factor(km$cluster)
# add additional column to dataset with cluster numbers
full_dataset$clusternum <- kmeansRes
full_dataset

```

```{r kmeans_count,message = FALSE}
# size of clusters generated by Kmeans
metrics <- full_dataset %>% count(clusternum)
metrics
```

## Plot Kmeans results to analyse the clusters:

```{r plot,message = FALSE}
ggplot(full_dataset, aes(y=clusternum,fill=factor(T3_14.80))) +
  geom_bar(position="fill") +
  scale_fill_manual(values=c("deepskyblue","skyblue","blue","navy"),labels = c("Without Difficulty","Some Difficulty","A lot of Difficulty","Unable")) +
  labs(
    title = "Ability to cover monthly expenses by cluster",
    x = "Proportion",
    y = "Cluster Numbers",
    fill = "Abilty",
    caption = "Cluster #3 has highest percentage of subjects without difficulty, and no subjects who are 
    unable to cover their expenses. Cluster #4 has the highest percentage of subjects who are 
    unable to cover expenses"
  ) +
  theme_minimal()
```


```{r plot2,message = FALSE}
ggplot(full_dataset, aes(y=clusternum,fill=factor(T3education_level))) +
  geom_bar(position="fill")+
  scale_fill_manual(values=c("turquoise","deepskyblue","skyblue","seagreen4","blue","deepskyblue4","navy"),labels = c("Primary School or Middle School","Completed High School","High School Diploma","Post High School Diploma","First Degree","Other Certificate","None")) +
  labs(
    title = "Education Level by cluster",
    x = "Proportion",
    y = "Cluster Numbers",
    fill = "Education Level",
    caption = "Cluster #3 has highest percentage post high school diploma and academic degrees.
    The maximal education level for cluster #4 is high school diploma."
  ) +
  theme_minimal()

```

```{r plot5,message = FALSE}

ggplot(full_dataset, aes(y=clusternum,fill=factor(round(B.SUPPORT_3)))) +
  geom_bar(position="fill") +
  scale_fill_manual(values=c("deepskyblue","skyblue","blue","navy"),labels = c("Slightly","Moderately","Very Much","Extremely")) +
  labs(
    title = "To which extent the subject feels loved and cared for.",
    x = "Proportion",
    y = "Cluster Numbers",
    fill = "Extent",
    caption = "Cluster #3 has almost 100% of rating above 'very much'. Cluster #4 has the highest percent of low ratings."
  ) +
  theme_minimal()
```
```{r plot9}

ggplot(full_dataset, aes(y=clusternum,fill=factor(round(B.LONELY_2)))) +
  geom_bar(position="fill")  +
  scale_fill_manual(values=c("deepskyblue","seagreen4","skyblue","blue","navy"),labels = c("Not at All","Slightly","Moderately","Very Much","Extremely")) +
  labs(
    title = "To which extent the subject feels they are surrounded by people they trust.",
    x = "Proportion",
    y = "Cluster Numbers",
    fill = "Extent",
    caption = "Cluster #3 has only around 15% of low ratings, meaning they mostly feel they have 
    people they can trust. Cluster #4 has around 40% of low ratings."
  ) +
  theme_minimal()
```

### Other plots tested for correlation:
The below connections turned out to be less significant.

```{r plot3,message = FALSE}

ggplot(full_dataset, aes(y=clusternum,fill=factor(MentorFreq))) +
  geom_bar(position="fill") +
  scale_fill_manual(values=c("deepskyblue","seagreen4","skyblue","blue","navy"),labels = c("Never","Once in a Few Months","Once a Month","Once a Week","Twice or 3 Times a Week")) +
  labs(
    title = "How often the subject conatact their mentor.",
    x = "Proportion",
    y = "Cluster Numbers",
    fill = "Frequecny",
  ) +
  theme_minimal()

```

```{r plot4,message = FALSE}

ggplot(full_dataset, aes(y=clusternum,fill=factor(round(PnimiaTrust)))) +
  geom_bar(position="fill") +
  scale_fill_manual(values=c("deepskyblue","seagreen4","skyblue","blue","navy"),labels = c("Not at All","Slightly","Moderately","Very Much","Extremely")) +
  labs(
    title = "To which extent the subject can trust the boarding school staff.",
    x = "Proportion",
    y = "Cluster Numbers",
    fill = "Extent",
  ) +
  theme_minimal()
```

```{r plot7,message = FALSE}

ggplot(full_dataset, aes(y=clusternum,fill=factor(round(B.CONTACT)))) +
  geom_bar(position="fill") +
  scale_fill_manual(values=c("skyblue","blue"),labels = c("No","Yes")) +
  labs(
    title = "Has the subject been in contact with the boarding school staff since they left.",
    x = "Proportion",
    y = "Cluster Numbers",
    fill = "Contact",
  ) +
  theme_minimal()

```

```{r plot8,message = FALSE}

ggplot(full_dataset, aes(y=clusternum,fill=factor(round(B.RAKAZ.SUPPORT)))) +
  geom_bar(position="fill") +
  scale_fill_manual(values=c("deepskyblue","seagreen4","skyblue","blue","navy","mediumpurple3"),labels = c("Not at All","Slightly","Moderately","Very Much","Extremely","Not Answered")) +
  labs(
    title = "To which extent the subject feels the relation with the boarding school staff has helped them since they left",
    x = "Proportion",
    y = "Cluster Numbers",
    fill = "Extent",
  ) +
  theme_minimal()

```

## Regression Models based Kmeans results:

```{r model1,message = FALSE}

vars <- c("MentorFreq","PnimiaTrust","B.SUPPORT_3","B.CONTACT","B.RAKAZ.SUPPORT","B.LONELY_1")
res <- c("T3_14.80","T3education_level")


multi.fit.lm <- lm(T3_14.80 ~ MentorFreq+PnimiaTrust+B.SUPPORT_3+B.CONTACT+B.RAKAZ.SUPPORT+B.LONELY_1, data = full_dataset)
summary(multi.fit.lm)
```

```{r model2,message = FALSE}

vars <- c("MentorFreq","PnimiaTrust","B.SUPPORT_3","B.CONTACT","B.RAKAZ.SUPPORT","B.LONELY_1")
res <- c("T3_14.80","T3education_level")


multi2.fit.lm <- lm(T3education_level ~ MentorFreq+PnimiaTrust+B.SUPPORT_3+B.CONTACT+B.RAKAZ.SUPPORT+B.LONELY_1, data = full_dataset)
summary(multi2.fit.lm)
```

## Stepwise regression models for signifact dependent variables:

The expected result is that the dependent variables found in Kmeans have significant models.

```{r model3,message = FALSE}
library(MASS)

# Fit the full model 
full.model <- lm(T3_14.80 ~ . -serial_number - T3housing_status - T3education_level - T3army_fullservice - T3civil_service - T3_job - T3job_seeking - T3T314.10 - T3_10.150 - T3_14.80 - T3_15.80, data = full_dataset)
# Stepwise regression model
step.model <- stepAIC(full.model, direction = "both", 
                      trace = FALSE)
summary(step.model)
```

```{r model4,message = FALSE}

# Fit the full model 
full2.model <- lm(T3education_level ~ .-serial_number - T3housing_status - T3_14.80 - T3army_fullservice - T3civil_service - T3_job - T3job_seeking - T3T314.10 - T3_10.150 - T3_14.80 - T3_15.80, data = full_dataset)
# Stepwise regression model
step.model <- stepAIC(full2.model, direction = "both", 
                      trace = FALSE)
summary(step.model)
```

```{r model5,message = FALSE}

# Fit the full model 
full3.model <- lm(T3_job ~ . -serial_number - T3housing_status - T3_14.80 - T3army_fullservice - T3civil_service - T3education_level - T3job_seeking - T3T314.10 - T3_10.150 - T3_14.80 - T3_15.80, data = full_dataset)
# Stepwise regression model
step.model <- stepAIC(full3.model, direction = "both", 
                      trace = FALSE)
summary(step.model)
```

```{r model6,message = FALSE}

# Fit the full model 
full4.model <- lm(T3_10.150 ~ . -B.LIFE.SKILLS.ALL_8 -serial_number - T3housing_status - T3_14.80 - T3army_fullservice - T3civil_service - T3education_level - T3job_seeking - T3T314.10 - T3_job - T3_14.80 - T3_15.80, data = full_dataset)
# Stepwise regression model
step.model <- stepAIC(full4.model, direction = "both", 
                      trace = FALSE)
summary(step.model)
```
